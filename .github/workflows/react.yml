name: react deploy

concurrency:
    group: production
    cancel-in-progress: true

on:
    push:
        branches: [ "main" ]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            -   name: Clone repository
                uses: actions/checkout@v3
            -   name: Use Node.js
                uses: actions/setup-node@v3
                with:
                    node-version: 16
            -   name: Install dependencies
                run: npm ci
            -   name: Test
                run: npm test
                env:
                    CI: true
            -   name: Generate build
                run: npm run build
            -   name: Share artifact inside workflow
                uses: actions/upload-artifact@v3
                with:
                    name: build
                    path: build
    deploy:
        runs-on: ubuntu-latest
        environment: production
        concurrency: production
        needs: build
        steps:
            -   name: Get artifact
                uses: actions/download-artifact@v3
                with:
                    name: build
            -   name: Deploy
                run: ./.github/scripts/deploy.sh
                shell: bash
                env:
                    PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
